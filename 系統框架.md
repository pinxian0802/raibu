# 🚀 Raibu 系統框架規格書

**版本**: 3.1
**日期**: 2025/12
**狀態**: 與 PRD v3.0 同步

---

## I. 🎯 系統設計總覽

### 核心架構概念

| 設計元素                   | 目的/效益                                          | 相關模型/API                            |
| :------------------------- | :------------------------------------------------- | :-------------------------------------- |
| **雙模式架構**             | 紀錄模式與詢問模式分離，資料結構與顯示邏輯獨立。   | Record Model / Ask Model                |
| **圖片為核心的座標系統**   | 紀錄標點無單一座標，空間存在完全依賴所屬圖片座標。 | Record Model + Image Media Model        |
| **Smart Filter 機制**      | 紀錄模式建立時過濾無 GPS 圖片，確保每張圖可定位。  | 前端相簿過濾邏輯                        |
| **兩階段上傳**             | 實現極速上傳，避免應用伺服器 I/O 瓶頸。            | API 授權 → 前端直傳 R2 → API 提交       |
| **client_key (Key-Value)** | 消除多圖上傳混淆，保證前端對應憑證的準確性。       | Upload API 請求/回應                    |
| **原子性 PENDING 狀態**    | 確保數據一致性，並啟用後台清理機制。               | Image Media Model                       |
| **Geo-fencing 判斷**       | 詢問模式回覆時，自動判定是否為實地回報。           | Reply Model (`is_onsite` 欄位)          |
| **48 小時生命週期**        | 詢問標點自動過期，維持地圖資訊即時性。             | Ask Model (`created_at` + 後端查詢過濾) |
| **像素距離群集演算法**     | 優化地圖效能與視覺體驗，動態聚合標點。             | 前端群集運算 + API 範圍查詢             |

---

## II. 💾 資料模型 (Supabase Tables)

### 1. 👤 使用者記錄 (User Model)

| 欄位             | 類型      | 備註                           | 關鍵用途          |
| :--------------- | :-------- | :----------------------------- | :---------------- |
| **id**           | UUID (PK) | 主鍵 ID，由 Supabase Auth 產生 |                   |
| **display_name** | Text      | 顯示名稱                       | 個人頁面          |
| **avatar_url**   | Text      | 頭像圖片 URL                   | 個人頁面/作者資訊 |
| **total_views**  | Integer   | 累計被觀看次數                 | 個人頁面統計      |
| **created_at**   | Timestamp | 帳號建立時間                   |                   |

---

### 2. 📍 紀錄標點主記錄 (Record Model)

> **核心概念**：紀錄標點**本身不具備單一座標**，其空間存在完全依賴於所屬圖片的 GPS 座標。

| 欄位               | 類型      | 備註                             | 關鍵用途          |
| :----------------- | :-------- | :------------------------------- | :---------------- |
| **id**             | UUID (PK) | 主鍵 ID                          |                   |
| **user_id**        | UUID (FK) | 建立者 ID，連結 User Model       | 權限控制          |
| **description**    | Text      | 標點描述（必填）                 | 內容顯示          |
| **main_image_url** | Text      | 首圖縮圖 URL（冗餘欄位）         | 加速地圖/列表顯示 |
| **media_count**    | Integer   | 關聯圖片數量（冗餘欄位，預設 0） | 加速列表查詢      |
| **like_count**     | Integer   | 愛心數（預設 0）                 | 排序/統計         |
| **view_count**     | Integer   | 觀看次數（預設 0）               | 統計              |
| **created_at**     | Timestamp | 記錄建立時間                     | 時間排序          |
| **updated_at**     | Timestamp | 最後更新時間                     | 編輯追蹤          |

> **冗餘欄位維護規則**：
>
> - `main_image_url`：建立/編輯標點時，設為 `display_order = 0` 的圖片縮圖
> - `media_count`：新增/刪除圖片時，由後端 API 同步更新

---

### 3. ❓ 詢問標點主記錄 (Ask Model)

> **核心概念**：詢問標點具有**單一中心座標**與**詢問範圍半徑**，並有 **48 小時生命週期**。

| 欄位               | 類型                  | 備註                                | 關鍵用途          |
| :----------------- | :-------------------- | :---------------------------------- | :---------------- |
| **id**             | UUID (PK)             | 主鍵 ID                             |                   |
| **user_id**        | UUID (FK)             | 建立者 ID，連結 User Model          | 權限控制          |
| **center**         | GEOMETRY(Point, 4326) | 詢問中心座標（PostGIS 格式）        | 地圖標記/空間查詢 |
| **radius_meters**  | Integer               | 詢問範圍半徑（公尺），預設 500      | Geo-fencing 判斷  |
| **question**       | Text                  | 問題內容（必填）                    | 內容顯示          |
| **main_image_url** | Text                  | 首圖縮圖 URL（冗餘欄位，可為 Null） | 列表顯示          |
| **status**         | Enum                  | `ACTIVE` / `RESOLVED`               | 狀態追蹤          |
| **like_count**     | Integer               | 愛心數（預設 0）                    | 排序/統計         |
| **view_count**     | Integer               | 觀看次數（預設 0）                  | 統計              |
| **created_at**     | Timestamp             | 記錄建立時間                        | 生命週期計算      |
| **updated_at**     | Timestamp             | 最後更新時間                        | 編輯追蹤          |

> **PostGIS 說明**：
>
> - `GEOMETRY(Point, 4326)` 是 WGS84 座標系統（與 GPS 一致）
> - 需在 Supabase 啟用 PostGIS 擴展：`CREATE EXTENSION IF NOT EXISTS postgis;`
> - 建立空間索引：`CREATE INDEX idx_asks_center ON asks USING GIST (center);`
>
> **前端顯示規則**：僅顯示 `created_at` 在過去 48 小時內的詢問標點。

---

### 4. 🖼️ 圖片媒體記錄 (Image Media Model)

> **核心概念**：每張圖片皆有獨立 Metadata，紀錄模式圖片**強制需要 GPS**，其他情境圖片 GPS **可選**。

| 欄位                     | 類型                  | 備註                                  | 關鍵用途            |
| :----------------------- | :-------------------- | :------------------------------------ | :------------------ |
| **id**                   | UUID (PK)             | 圖片記錄 ID                           |                     |
| **user_id**              | UUID (FK)             | 上傳者 ID（**安全驗證必須**）         | 驗證 upload_id 歸屬 |
| **client_key**           | Text                  | 前端本地識別碼（除錯追蹤用）          | 問題排查            |
| **record_id**            | UUID (FK)             | 外鍵，連結 Record Model（可為 Null）  | 紀錄模式圖片        |
| **ask_id**               | UUID (FK)             | 外鍵，連結 Ask Model（可為 Null）     | 詢問模式附圖        |
| **reply_id**             | UUID (FK)             | 外鍵，連結 Reply Model（可為 Null）   | 回覆附圖            |
| **status**               | Enum                  | `PENDING` / `COMPLETED`               | 原子性控制          |
| **original_public_url**  | Text                  | 永久的原圖 CDN URL                    | 詳細頁顯示          |
| **thumbnail_public_url** | Text                  | 縮圖 CDN URL                          | 地圖縮圖顯示        |
| **location**             | GEOMETRY(Point, 4326) | 圖片 EXIF 提取的拍攝座標（可為 Null） | 地圖定位/空間查詢   |
| **captured_at**          | Timestamp             | 圖片 EXIF 提取的拍攝時間（可為 Null） | 時間排序            |
| **uploaded_at**          | Timestamp             | Metadata 首次存入資料庫時間           | PENDING 清理依據    |
| **display_order**        | Integer               | 圖片在該標點中的顯示順序              | Carousel 錨點定位   |

> **重要**：
>
> - `record_id`、`ask_id`、`reply_id` 三者互斥，一張圖片只會屬於其中一種
> - `user_id` 在 API A-1（請求憑證）時寫入，用於後續驗證 upload_id 歸屬
> - 建立空間索引：`CREATE INDEX idx_images_location ON image_media USING GIST (location);`

---

### 5. 💬 回覆記錄 (Reply Model)

| 欄位           | 類型      | 備註                                 | 關鍵用途     |
| :------------- | :-------- | :----------------------------------- | :----------- |
| **id**         | UUID (PK) | 回覆記錄 ID                          |              |
| **record_id**  | UUID (FK) | 外鍵，連結 Record Model（可為 Null） | 紀錄標點回覆 |
| **ask_id**     | UUID (FK) | 外鍵，連結 Ask Model（可為 Null）    | 詢問標點回覆 |
| **user_id**    | UUID (FK) | 回覆者 ID                            | 作者資訊     |
| **content**    | Text      | 回覆文字內容（必填）                 | 內容顯示     |
| **is_onsite**  | Boolean   | 是否為實地回報，預設 `false`         | 後端排序權重 |
| **like_count** | Integer   | 愛心數（預設 0）                     | 排序/統計    |
| **created_at** | Timestamp | 回覆建立時間                         | 時間排序     |

> **Geo-fencing 判定邏輯**（僅對詢問標點回覆執行）：
>
> - 條件：`(回覆附圖有 GPS) AND (座標在詢問範圍 + 30 公尺內)`
> - **符合** → `is_onsite = true`
> - **不符合** → `is_onsite = false`
>
> **注意**：前端 **不顯示** `is_onsite` 標籤，此欄位僅供後端排序或數據分析使用。

---

### 6. ❤️ 愛心記錄 (Like Model)

| 欄位           | 類型      | 備註                                 | 關鍵用途       |
| :------------- | :-------- | :----------------------------------- | :------------- |
| **id**         | UUID (PK) | 愛心記錄 ID                          |                |
| **user_id**    | UUID (FK) | 點讚者 ID                            | 防重複點讚     |
| **record_id**  | UUID (FK) | 外鍵，連結 Record Model（可為 Null） | 對紀錄標點點讚 |
| **ask_id**     | UUID (FK) | 外鍵，連結 Ask Model（可為 Null）    | 對詢問標點點讚 |
| **reply_id**   | UUID (FK) | 外鍵，連結 Reply Model（可為 Null）  | 對回覆點讚     |
| **created_at** | Timestamp | 點讚時間                             |                |

> **唯一約束**：`(user_id, record_id)`、`(user_id, ask_id)`、`(user_id, reply_id)` 需設定唯一索引，防止重複點讚。

---

## III. 🚀 API 規格

### 3.0 通用錯誤回應 (Error Handling)

所有 API 在發生錯誤時 (4xx, 5xx)，皆回傳統一 JSON 格式，方便前端統一處理。

**Response Body (Error)**:

```json
{
  "error": {
    "code": "INVALID_ARGUMENT", // 機器可讀的錯誤代碼
    "message": "圖片數量超過上限", // 人類可讀的錯誤訊息 (可直接顯示給 User)
    "details": {
      // (選填) 詳細除錯資訊
      "field": "images",
      "limit": 10
    }
  }
}
```

**常用錯誤代碼 (Code)**:

- `INVALID_ARGUMENT`: 參數錯誤 (如欄位缺漏、格式不符)
- `UNAUTHENTICATED`: 未登入或 Token 無效
- `PERMISSION_DENIED`: 無權限 (如編輯他人的文章)
- `NOT_FOUND`: 找不到資源
- `RESOURCE_EXHAUSTED`: 配額不足 (如上傳超過限制)
- `INTERNAL`: 伺服器內部錯誤

---

### 模組 A：圖片上傳 API

#### 📤 API A-1: 批次上傳授權與 PENDING 創建

> 為所有圖片生成 PENDING 記錄和上傳憑證。

**端點**: `POST /api/v1/upload/request`

**Request Payload**:

```json
{
  "image_requests": [
    {
      "client_key": "local_img_001",
      "fileType": "image/jpeg",
      "fileSize": 5120000
    },
    {
      "client_key": "local_img_002",
      "fileType": "image/png",
      "fileSize": 8500000
    }
  ]
}
```

**Response Body**:

```json
{
  "upload_credentials": {
    "local_img_001": {
      "upload_id": "a93b2f4c-1111-45b6-b8c7-d1e2f3g4h5i6",
      "original_upload_url": "https://r2.cdn.com/temp/1111_orig?sig=ABCDE",
      "thumbnail_upload_url": "https://r2.cdn.com/temp/1111_thumb?sig=FGHIJ",
      "original_public_url": "https://cdn.example.com/user_A/1111-orig.jpg",
      "thumbnail_public_url": "https://cdn.example.com/user_A/1111-thumb.jpg"
    },
    "local_img_002": {
      "upload_id": "b0c1d2e3-2222-67d8-f9a0-g1h2i3j4k5l6",
      "original_upload_url": "https://r2.cdn.com/temp/2222_orig?sig=KLMNO",
      "thumbnail_upload_url": "https://r2.cdn.com/temp/2222_thumb?sig=PQRST",
      "original_public_url": "https://cdn.example.com/user_A/2222-orig.png",
      "thumbnail_public_url": "https://cdn.example.com/user_A/2222-thumb.png"
    }
  }
}
```

**後端操作**：

1. 驗證 authToken，取得當前用戶 ID
2. 為每個 `image_request` 建立 PENDING 記錄：
   ```sql
   INSERT INTO image_media (id, user_id, client_key, status, uploaded_at)
   VALUES (uuid_generate_v4(), {current_user_id}, {client_key}, 'PENDING', NOW());
   ```
3. 向 R2 請求 Presigned URLs（有效期 15 分鐘）
4. 回傳憑證 Map

---

### 🔄 兩階段上傳完整流程 (Two-Phase Upload Flow)

> 此流程適用於所有需要上傳圖片的情境：建立紀錄標點、建立詢問標點、回覆標點。

#### 流程總覽

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           兩階段上傳流程時序圖                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  前端 (App)                     後端 (API)                  Cloudflare R2       │
│      │                              │                             │            │
│      │  ① 請求上傳憑證 (1~10張)      │                             │            │
│      │  POST /api/v1/upload/request │                             │            │
│      │ ─────────────────────────────>│                             │            │
│      │                              │                             │            │
│      │                              │  創建 PENDING 記錄           │            │
│      │                              │  生成 Presigned URLs        │            │
│      │                              │                             │            │
│      │  ② 回傳憑證 (Key-Value Map)   │                             │            │
│      │ <─────────────────────────────│                             │            │
│      │                              │                             │            │
│      │  ③ 並行直傳圖片至 R2 (最多10張) │                             │            │
│      │ ──────────────────────────────────────────────────────────>│            │
│      │  PUT original_upload_url     │                             │            │
│      │  PUT thumbnail_upload_url    │                             │            │
│      │                              │                             │            │
│      │  ④ R2 回傳上傳成功            │                             │            │
│      │ <──────────────────────────────────────────────────────────│            │
│      │                              │                             │            │
│      │  ⑤ 提交完整 Metadata          │                             │            │
│      │  POST /api/v1/records (或其他)│                             │            │
│      │ ─────────────────────────────>│                             │            │
│      │                              │                             │            │
│      │                              │  更新 PENDING → COMPLETED    │            │
│      │                              │  關聯至 Record/Ask/Reply    │            │
│      │                              │                             │            │
│      │  ⑥ 回傳成功結果               │                             │            │
│      │ <─────────────────────────────│                             │            │
│      │                              │                             │            │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

#### 步驟詳解

##### 步驟 ① ②：請求上傳憑證 (API A-1)

前端選取 1~10 張圖片後，為每張圖片生成唯一的 `client_key`，一次性請求所有憑證。

**請求範例 (10 張圖片)**：

```json
{
  "image_requests": [
    { "client_key": "img_001", "fileType": "image/jpeg", "fileSize": 5120000 },
    { "client_key": "img_002", "fileType": "image/jpeg", "fileSize": 4800000 },
    { "client_key": "img_003", "fileType": "image/jpeg", "fileSize": 6200000 },
    { "client_key": "img_004", "fileType": "image/png", "fileSize": 8500000 },
    { "client_key": "img_005", "fileType": "image/jpeg", "fileSize": 3900000 },
    { "client_key": "img_006", "fileType": "image/jpeg", "fileSize": 5500000 },
    { "client_key": "img_007", "fileType": "image/heic", "fileSize": 7200000 },
    { "client_key": "img_008", "fileType": "image/jpeg", "fileSize": 4100000 },
    { "client_key": "img_009", "fileType": "image/jpeg", "fileSize": 5800000 },
    { "client_key": "img_010", "fileType": "image/jpeg", "fileSize": 4500000 }
  ]
}
```

**回應範例**：

```json
{
  "upload_credentials": {
    "img_001": {
      "upload_id": "uuid-0001",
      "original_upload_url": "https://r2.cdn.com/temp/0001_orig?X-Amz-Signature=...",
      "thumbnail_upload_url": "https://r2.cdn.com/temp/0001_thumb?X-Amz-Signature=...",
      "original_public_url": "https://cdn.raibu.app/images/0001-orig.jpg",
      "thumbnail_public_url": "https://cdn.raibu.app/images/0001-thumb.jpg"
    },
    "img_002": { "upload_id": "uuid-0002", "..." },
    "img_003": { "upload_id": "uuid-0003", "..." },
    "img_004": { "upload_id": "uuid-0004", "..." },
    "img_005": { "upload_id": "uuid-0005", "..." },
    "img_006": { "upload_id": "uuid-0006", "..." },
    "img_007": { "upload_id": "uuid-0007", "..." },
    "img_008": { "upload_id": "uuid-0008", "..." },
    "img_009": { "upload_id": "uuid-0009", "..." },
    "img_010": { "upload_id": "uuid-0010", "..." }
  }
}
```

> **Presigned URL 說明**：
>
> - `original_upload_url` / `thumbnail_upload_url`：帶有簽名的臨時上傳 URL（有效期約 15 分鐘）
> - `original_public_url` / `thumbnail_public_url`：上傳成功後的永久訪問 URL（存入資料庫）

---

##### 步驟 ③：前端並行直傳 R2

前端收到憑證後，**並行**將每張圖片的原圖與縮圖上傳至 R2。

###### 前端實作範例 (JavaScript/React Native)

```javascript
/**
 * 並行上傳最多 10 張圖片至 R2
 * @param {Array} selectedImages - 使用者選取的圖片陣列
 * @param {Object} credentials - API A-1 回傳的憑證 Map
 */
async function uploadImagesToR2(selectedImages, credentials) {
  // 建立所有上傳任務（每張圖片 = 原圖 + 縮圖 = 2 個請求）
  const uploadTasks = selectedImages.flatMap((image) => {
    const cred = credentials[image.clientKey];

    return [
      // 上傳原圖
      uploadSingleFile(
        image.originalBlob,
        cred.original_upload_url,
        image.fileType
      ),
      // 上傳縮圖（前端預先生成）
      uploadSingleFile(
        image.thumbnailBlob,
        cred.thumbnail_upload_url,
        "image/jpeg"
      ),
    ];
  });

  // Promise.all 並行執行所有上傳（最多 20 個請求：10 張 × 2）
  const results = await Promise.all(uploadTasks);

  // 檢查是否全部成功
  const allSuccess = results.every((r) => r.success);
  if (!allSuccess) {
    throw new Error("部分圖片上傳失敗");
  }

  return true;
}

/**
 * 單一檔案上傳至 Presigned URL
 */
async function uploadSingleFile(blob, presignedUrl, contentType) {
  try {
    const response = await fetch(presignedUrl, {
      method: "PUT",
      headers: {
        "Content-Type": contentType,
      },
      body: blob,
    });

    return { success: response.ok };
  } catch (error) {
    console.error("Upload failed:", error);
    return { success: false, error };
  }
}
```

###### 前端實作範例 (Swift/iOS)

```swift
import Foundation

/// 並行上傳最多 10 張圖片至 R2
func uploadImagesToR2(
    selectedImages: [SelectedImage],
    credentials: [String: UploadCredential]
) async throws {

    // 使用 TaskGroup 並行上傳
    try await withThrowingTaskGroup(of: Void.self) { group in
        for image in selectedImages {
            guard let cred = credentials[image.clientKey] else { continue }

            // 加入原圖上傳任務
            group.addTask {
                try await self.uploadSingleFile(
                    data: image.originalData,
                    to: cred.originalUploadUrl,
                    contentType: image.fileType
                )
            }

            // 加入縮圖上傳任務
            group.addTask {
                try await self.uploadSingleFile(
                    data: image.thumbnailData,
                    to: cred.thumbnailUploadUrl,
                    contentType: "image/jpeg"
                )
            }
        }

        // 等待所有任務完成（最多 20 個並行請求）
        try await group.waitForAll()
    }
}

/// 單一檔案上傳至 Presigned URL
private func uploadSingleFile(
    data: Data,
    to presignedUrl: URL,
    contentType: String
) async throws {
    var request = URLRequest(url: presignedUrl)
    request.httpMethod = "PUT"
    request.setValue(contentType, forHTTPHeaderField: "Content-Type")
    request.httpBody = data

    let (_, response) = try await URLSession.shared.data(for: request)

    guard let httpResponse = response as? HTTPURLResponse,
          (200...299).contains(httpResponse.statusCode) else {
        throw UploadError.uploadFailed
    }
}
```

---

##### 縮圖生成規格

前端在上傳前需自行生成縮圖：

| 屬性     | 規格                       |
| :------- | :------------------------- |
| **尺寸** | 最長邊 300px，保持原始比例 |
| **格式** | JPEG                       |
| **品質** | 0.7 (70%)                  |
| **命名** | 由後端在憑證中提供完整路徑 |

###### 縮圖生成範例 (JavaScript)

```javascript
async function generateThumbnail(originalBlob, maxSize = 300, quality = 0.7) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => {
      // 計算縮放比例
      const scale = Math.min(maxSize / img.width, maxSize / img.height, 1);
      const width = Math.round(img.width * scale);
      const height = Math.round(img.height * scale);

      // Canvas 繪製
      const canvas = document.createElement("canvas");
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, width, height);

      // 輸出 JPEG Blob
      canvas.toBlob(resolve, "image/jpeg", quality);
    };
    img.src = URL.createObjectURL(originalBlob);
  });
}
```

---

##### 步驟 ⑤：提交完整 Metadata

所有圖片上傳成功後，前端呼叫對應的建立 API（如 `POST /api/v1/records`），一次性提交：

- 標點主體資訊（描述、座標等）
- 所有圖片的 Metadata（`upload_id`、EXIF 資訊、public URLs）

**請求範例（建立紀錄標點，含 10 張圖片）**：

```json
{
  "description": "今天的環島之旅紀錄",
  "images": [
    {
      "upload_id": "uuid-0001",
      "original_public_url": "https://cdn.raibu.app/images/0001-orig.jpg",
      "thumbnail_public_url": "https://cdn.raibu.app/images/0001-thumb.jpg",
      "location": { "lat": 25.033, "lng": 121.5654 },
      "captured_at": "2025-12-16T08:00:00Z",
      "display_order": 0
    },
    {
      "upload_id": "uuid-0002",
      "original_public_url": "https://cdn.raibu.app/images/0002-orig.jpg",
      "thumbnail_public_url": "https://cdn.raibu.app/images/0002-thumb.jpg",
      "location": { "lat": 24.1477, "lng": 120.6736 },
      "captured_at": "2025-12-16T10:30:00Z",
      "display_order": 1
    },
    {
      "upload_id": "uuid-0003",
      "location": { "lat": 23.4518, "lng": 120.2544 },
      "captured_at": "2025-12-16T12:15:00Z",
      "display_order": 2
    },
    {
      "upload_id": "uuid-0004",
      "location": { "lat": 22.6273, "lng": 120.3014 },
      "captured_at": "2025-12-16T14:00:00Z",
      "display_order": 3
    },
    {
      "upload_id": "uuid-0005",
      "location": { "lat": 22.0, "lng": 120.7333 },
      "captured_at": "2025-12-16T15:30:00Z",
      "display_order": 4
    },
    {
      "upload_id": "uuid-0006",
      "location": { "lat": 22.7563, "lng": 121.151 },
      "captured_at": "2025-12-16T17:00:00Z",
      "display_order": 5
    },
    {
      "upload_id": "uuid-0007",
      "location": { "lat": 23.9871, "lng": 121.6013 },
      "captured_at": "2025-12-16T19:00:00Z",
      "display_order": 6
    },
    {
      "upload_id": "uuid-0008",
      "location": { "lat": 24.2664, "lng": 121.7413 },
      "captured_at": "2025-12-16T20:00:00Z",
      "display_order": 7
    },
    {
      "upload_id": "uuid-0009",
      "location": { "lat": 24.7736, "lng": 121.7434 },
      "captured_at": "2025-12-16T21:00:00Z",
      "display_order": 8
    },
    {
      "upload_id": "uuid-0010",
      "location": { "lat": 25.0478, "lng": 121.5171 },
      "captured_at": "2025-12-16T22:30:00Z",
      "display_order": 9
    }
  ]
}
```

**後端操作**：

1. 建立 Record 主記錄
2. 遍歷 `images` 陣列，根據 `upload_id` 找到對應的 PENDING 記錄
3. 更新每筆 Image Media：寫入 EXIF 資訊、設定 `record_id`、狀態改為 `COMPLETED`
4. 回傳成功結果

---

##### 錯誤處理與重試機制

| 錯誤情境                           | 處理方式                                             |
| :--------------------------------- | :--------------------------------------------------- |
| API A-1 請求失敗                   | 提示網路錯誤，使用者點擊重試                         |
| 部分圖片上傳 R2 失敗               | 僅重試失敗的圖片，成功的不重傳                       |
| 所有圖片上傳成功，但 API 提交失敗  | 重試提交；若多次失敗，PENDING 記錄由後台清理任務處理 |
| Presigned URL 過期（超過 15 分鐘） | 重新呼叫 API A-1 取得新憑證                          |

---

##### 數量與大小限制

| 限制項目             | 數值                  |
| :------------------- | :-------------------- |
| 單次上傳最多圖片數   | 10 張                 |
| 單張圖片最大大小     | 20 MB                 |
| 允許的圖片格式       | JPEG, PNG, HEIC, WebP |
| Presigned URL 有效期 | 15 分鐘               |

---

### 模組 B：紀錄模式 API

#### 📝 API B-1: 建立紀錄標點

**端點**: `POST /api/v1/records`

**Request Payload**:

```json
{
  "description": "美麗華摩天輪夜景",
  "images": [
    {
      "upload_id": "a93b2f4c-1111-45b6-b8c7-d1e2f3g4h5i6",
      "location": { "lat": 25.0351, "lng": 121.5642 },
      "captured_at": "2025-12-11T20:30:00Z",
      "display_order": 0
    },
    {
      "upload_id": "b0c1d2e3-2222-67d8-f9a0-g1h2i3j4k5l6",
      "location": { "lat": 25.0355, "lng": 121.5648 },
      "captured_at": "2025-12-11T20:31:30Z",
      "display_order": 1
    }
  ]
}
```

**後端操作**:

1. **驗證 upload_id 歸屬**（安全性檢查）：
   ```sql
   -- 確認所有 upload_id 都屬於當前用戶且為 PENDING 狀態
   SELECT COUNT(*) FROM image_media
   WHERE id IN ({upload_ids})
     AND user_id = {current_user_id}
     AND status = 'PENDING';
   -- 若數量不符，回傳 403 Forbidden
   ```
2. 建立 Record 記錄，設定冗餘欄位：
   ```sql
   INSERT INTO records (id, user_id, description, main_image_url, media_count, created_at)
   VALUES (
     uuid_generate_v4(),
     {current_user_id},
     {description},
     {images[0].thumbnail_public_url},  -- 首圖縮圖
     {images.length},                    -- 圖片數量
     NOW()
   );
   ```
3. 更新 Image Media 記錄（PostGIS 格式）：
   ```sql
   UPDATE image_media
   SET
     record_id = {new_record_id},
     status = 'COMPLETED',
     location = ST_SetSRID(ST_MakePoint({lng}, {lat}), 4326),
     captured_at = {captured_at},
     display_order = {display_order}
   WHERE id = {upload_id};
   ```

---

#### 🗺️ API B-2: 取得地圖範圍內的紀錄圖片

> 用於地圖上顯示縮圖。

**端點**: `GET /api/v1/records/map`

**Query Parameters**:

- `min_lat`, `max_lat`, `min_lng`, `max_lng` - 地圖可視範圍

**後端查詢**（PostGIS 空間查詢）：

```sql
SELECT
  im.id as image_id,
  im.record_id,
  im.thumbnail_public_url,
  ST_X(im.location) as lng,
  ST_Y(im.location) as lat,
  im.display_order
FROM image_media im
WHERE im.status = 'COMPLETED'
  AND im.record_id IS NOT NULL
  AND ST_Within(
    im.location,
    ST_MakeEnvelope({min_lng}, {min_lat}, {max_lng}, {max_lat}, 4326)
  );
```

**Response Body**:

```json
{
  "images": [
    {
      "image_id": "img-uuid-1",
      "record_id": "record-uuid-1",
      "thumbnail_public_url": "https://cdn.example.com/thumb1.jpg",
      "lat": 25.0351,
      "lng": 121.5642,
      "display_order": 0
    }
  ]
}
```

---

#### 📖 API B-3: 取得紀錄標點詳情

**端點**: `GET /api/v1/records/{record_id}`

**Response Body**:

```json
{
  "id": "record-uuid-1",
  "description": "美麗華摩天輪夜景",
  "like_count": 42,
  "view_count": 128,
  "created_at": "2025-12-11T20:35:00Z",
  "author": {
    "id": "user-uuid",
    "display_name": "小明",
    "avatar_url": "https://cdn.example.com/avatar.jpg"
  },
  "images": [
    {
      "id": "img-uuid-1",
      "original_public_url": "https://cdn.example.com/orig1.jpg",
      "thumbnail_public_url": "https://cdn.example.com/thumb1.jpg",
      "location": { "lat": 25.0351, "lng": 121.5642 },
      "captured_at": "2025-12-11T20:30:00Z",
      "display_order": 0
    }
  ],
  "user_has_liked": false
}
```

---

#### ✏️ API B-4: 編輯紀錄標點

**端點**: `PATCH /api/v1/records/{record_id}`

**Request Payload**:

```json
{
  "description": "更新後的描述",
  "sorted_images": [
    {
      "type": "EXISTING", // 既有圖片
      "image_id": "existing-uuid-1"
    },
    {
      "type": "NEW", // 新增圖片
      "upload_id": "new-uuid-1",
      "location": { "lat": 25.0, "lng": 121.5 },
      "captured_at": "..."
      // 隱含 display_order = 1 (因為在陣列第二位)
    },
    {
      "type": "EXISTING",
      "image_id": "existing-uuid-2"
    }
  ]
}
```

> **設計變更 (Snapshot Sync)**：前端無需自行計算 `to_add`, `to_remove`, `reorder`。只需將「最終編輯好的圖片列表」按順序傳給後端，後端會自動比對差異並同步狀態。

**後端操作重點 (Diff & Sync Logic)**:

1.  **讀取現狀**: 查詢該 Record 目前資料庫中的所有圖片 (DB_Images)。
2.  **比對刪除 (Identify Deletions)**:
    - 找出存在於 `DB_Images` 但**不在** `sorted_images` (類型為 EXISTING) 中的圖片。
    - 執行刪除 (DB 移除 + R2 清理)。
3.  **處理新增 (Process Additions)**:
    - 針對 `sorted_images` 中 `type = NEW` 的項目。
    - 將對應 `upload_id` 的圖片狀態改為 `COMPLETED` 並連結 Record。
4.  **全面重排 (Re-index All)**:
    - 遍歷 `sorted_images` 陣列。
    - 依據陣列索引 (Index 0, 1, 2...) 更新每張圖片的 `display_order`。
5.  **更新首圖 (Update Main Image)**:
    - 取 `sorted_images[0]` (Index 0) 為新首圖。
    - 若陣列為空，`main_image_url` 設為 Null。

---

#### 💡 編輯流程範例 (Example Scenario)

**情境**: 原有 A, B。使用者**刪除 A**，**新增 C**，並排在 **B 之後** (順序變 B, C)。

1.  **前端準備**: 上傳 C 至 R2。
2.  **提交編輯**:
    ```json
    {
      "sorted_images": [
        { "type": "EXISTING", "image_id": "UUID-B" },
        { "type": "NEW", "upload_id": "UUID-C", ... }
      ]
    }
    ```
3.  **後端處理**:
    - **刪除**: 發現 UUID-A 不在列表中 → 刪除 A。
    - **新增**: 發現 UUID-C 是 NEW → 新增 C。
    - **排序**: UUID-B (order 0), UUID-C (order 1)。
    - **首圖**: 更新為 UUID-B。

---

#### 🗑️ API B-5: 刪除紀錄標點

**端點**: `DELETE /api/v1/records/{record_id}`

**後端操作**:

1. 刪除該 Record 及其所有關聯 Image Media 記錄
2. 刪除 R2 上對應檔案
3. 刪除所有關聯 Reply 與 Like 記錄

---

### 模組 C：詢問模式 API

#### ❓ API C-1: 建立詢問標點

**端點**: `POST /api/v1/asks`

**Request Payload**:

```json
{
  "center": { "lat": 25.035, "lng": 121.564 },
  "radius_meters": 500,
  "question": "這裡現在有沒有停車位？",
  "images": [{ "upload_id": "..." }]
}
```

> **注意**：詢問模式附圖不需要 GPS 資訊。

---

#### 🗺️ API C-2: 取得地圖範圍內的詢問標點

**端點**: `GET /api/v1/asks/map`

**Query Parameters**:

- `min_lat`, `max_lat`, `min_lng`, `max_lng` - 地圖可視範圍

**後端邏輯**:

- 過濾條件：`created_at >= NOW() - INTERVAL '48 hours'`

**Response Body**:

```json
{
  "asks": [
    {
      "id": "ask-uuid-1",
      "center": { "lat": 25.035, "lng": 121.564 },
      "radius_meters": 500,
      "question": "這裡現在有沒有停車位？",
      "status": "ACTIVE"
    }
  ]
}
```

---

#### 📖 API C-3: 取得詢問標點詳情

**端點**: `GET /api/v1/asks/{ask_id}`

---

#### ✏️ API C-4: 編輯詢問標點

**端點**: `PATCH /api/v1/asks/{ask_id}`

**Request Payload**:

```json
{
  "question": "更新後的問題內容...",
  "status": "RESOLVED", // 可選值: ACTIVE, RESOLVED
  "sorted_images": [
    { "type": "EXISTING", "image_id": "..." },
    { "type": "NEW", "upload_id": "..." }
  ]
}
```

**後端邏輯**:

- **狀態更新**: 允許作者將狀態切換為 `RESOLVED`。
- **圖片同步 (Snapshot Sync)**:
  - 支援新增/刪除/重排圖片，邏輯同 **API B-4**。
  - 若 `sorted_images` 為空陣列，則刪除所有圖片。

---

#### 🗑️ API C-5: 刪除詢問標點

**端點**: `DELETE /api/v1/asks/{ask_id}`

---

### 模組 D：回覆與互動 API

#### 💬 API D-1: 建立回覆

**端點**: `POST /api/v1/replies`

**Request Payload**:

```json
{
  "record_id": "record-uuid-1", // 或 ask_id，二擇一
  "content": "現在人很多喔！",
  "images": [
    {
      "upload_id": "...",
      "original_public_url": "...",
      "thumbnail_public_url": "...",
      "location": { "lat": 25.0352, "lng": 121.5643 }
    }
  ]
}
```

**後端 Geo-fencing 邏輯**（僅對 `ask_id` 回覆執行）:

```
IF ask_id IS NOT NULL THEN
  FOR EACH image IN images:
    IF image.location IS NOT NULL THEN
      distance = calculate_distance(image.location, ask.center)
      IF distance <= (ask.radius_meters + 30) THEN
        reply.is_onsite = true
        BREAK
      END IF
    END IF
  END FOR
END IF
```

---

#### 📋 API D-2: 取得回覆列表

**端點**: `GET /api/v1/replies?record_id={id}` 或 `GET /api/v1/replies?ask_id={id}`

**Response Body**:

```json
{
  "replies": [
    {
      "id": "reply-uuid-1",
      "content": "現在人很多喔！",
      "like_count": 5,
      "created_at": "2025-12-11T21:00:00Z",
      "author": {
        "id": "user-uuid",
        "display_name": "小華",
        "avatar_url": "..."
      },
      "images": [...],
      "user_has_liked": false
    }
  ]
}
```

---

#### ❤️ API D-3: 點讚 / 取消點讚

**端點**: `POST /api/v1/likes`

**Request Payload**（三擇一）:

```json
{
  "record_id": "record-uuid-1"
}
```

或

```json
{
  "ask_id": "ask-uuid-1"
}
```

或

```json
{
  "reply_id": "reply-uuid-1"
}
```

**後端邏輯**:

- 若已存在 Like 記錄 → 刪除（取消點讚）
- 若不存在 → 創建（點讚）
- 同步更新目標物件的 `like_count`

---

### 模組 E：使用者 / 個人頁面 API

#### 👤 API E-1: 取得個人資訊

**端點**: `GET /api/v1/users/me`

**Response Body**:

```json
{
  "id": "user-uuid",
  "display_name": "小明",
  "avatar_url": "...",
  "total_records": 15,
  "total_asks": 3,
  "total_views": 1024,
  "created_at": "2025-01-01T00:00:00Z"
}
```

---

#### 📋 API E-2: 取得使用者的標點列表

**端點**: `GET /api/v1/users/me/records`

**Response Body**:

```json
{
  "records": [
    {
      "id": "record-uuid-1",
      "description": "美麗華摩天輪夜景",
      "thumbnail_url": "...",
      "like_count": 42,
      "view_count": 128,
      "created_at": "..."
    }
  ]
}
```

---

#### ❓ API E-3: 取得使用者的詢問列表

**端點**: `GET /api/v1/users/me/asks`

**Response Body**:

```json
{
  "asks": [
    {
      "id": "ask-uuid-1",
      "question": "這裡現在有沒有停車位？",
      "center": { "lat": 25.035, "lng": 121.564 },
      "status": "ACTIVE",
      "like_count": 5,
      "view_count": 32,
      "created_at": "2025-12-16T10:00:00Z"
    }
  ]
}
```

---

## IV. 🗺️ 地圖顯示與群集邏輯

### 4.0 全域地圖功能

| 功能         | 說明                                             |
| :----------- | :----------------------------------------------- |
| **預設模式** | 進入 App 時預設為**紀錄模式**                    |
| **模式切換** | 介面上提供按鈕快速切換「紀錄模式」與「詢問模式」 |
| **搜尋功能** | 支援一般地點搜尋 (POI)，搜尋後地圖移動至該位置   |
| **定位按鈕** | 點擊後縮放至使用者當前位置                       |

### 4.1 紀錄模式地圖顯示

- **顯示元素**：圖片縮圖（非抽象 Pin）
- **樣式**：縮圖外層加上白色圓形邊框
- **多圖邏輯**：一則紀錄若含多張不同位置的圖片，地圖上會在多個位置顯示縮圖，點擊任一皆開啟同一則紀錄

### 4.2 詢問模式地圖顯示

- **顯示元素**：問號圖示（❓ Icon）
- **時效限制**：僅顯示過去 48 小時內的詢問

### 4.3 群集演算法

採用「基於像素距離的動態群集」機制：

| 參數 | 說明                             |
| :--- | :------------------------------- |
| R    | 螢幕像素半徑門檻（建議 40px）    |
| Z    | 當前地圖 Zoom Level              |
| D    | 由 R 與 Z 動態換算的實際地理距離 |

**運作邏輯**:

- 當兩點螢幕距離 < R → 合併為群集圖標（顯示數量）
- Zoom Out → D 變大 → 高聚合
- Zoom In → D 變小 → 低聚合

**遞進式點擊行為**:

| 條件                                     | 行為                                             |
| :--------------------------------------- | :----------------------------------------------- |
| 群集未達最大縮放                         | 自動 Zoom In，地圖中心移至群集中心               |
| 已達最大縮放，標點仍重疊（螢幕距離 < R） | 彈出 3/4 高度 Bottom Sheet，顯示重疊標點縮圖列表 |

**Bottom Sheet 內點擊行為**:

- 點擊列表任一項目 → 保持 Bottom Sheet 型式，內容切換為該筆紀錄的 Detail View

---

## V. 📱 UI 元件規格

### 5.1 詳細視窗 (Detail View)

| 屬性         | 規格                                        |
| :----------- | :------------------------------------------ |
| **UI 型式**  | 3/4 高度 Bottom Sheet（底部滑出面板）       |
| **手勢操作** | 從頂部 Handle 向下拖動關閉                  |
| **錨點定位** | 多圖紀錄開啟時，Carousel 定位至被點擊的圖片 |

### 5.2 詢問範圍滑桿

| 屬性         | 規格                                |
| :----------- | :---------------------------------- |
| **預設值**   | 500 公尺                            |
| **刻度選項** | 100m, 500m, 1km（可吸附，亦可微調） |
| **視覺預覽** | 地圖上顯示對應大小的圓形範圍        |

---

### 5.3 自定義相簿選擇器 (Custom Photo Picker)

> **設計核心**：讓使用者在選取的當下，即完成順序排列。

#### A. 選取與排序邏輯 (Selection & Ordering)

| 行為         | 邏輯說明                                                                                                                                                      |
| :----------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **按序編號** | 使用者點選圖片時，依序顯示數字徽章 (Badge)。<br>例如：點第一張顯示 `1`，點第二張顯示 `2`。                                                                    |
| **即時重排** | 若使用者取消選取中間的圖片（如 `2` 號），後續號碼（`3`, `4`...）需**立即自動遞補**。<br>例如：`1, 2, 3, 4, 5` → 取消 `2` → 變成 `1, 2(原3), 3(原4), 4(原5)`。 |
| **封鎖上限** | 當選滿 **10 張**時：<br>1. 未選取的圖片**變暗 (Dimmed)**。<br>2. 點擊未選圖片時，跳出 Toast/Alert 提示「已達 10 張上限」。                                    |

#### B. 預先篩選機制 (Pre-filtering)

- **時間限制**: 預設顯示最近 7 天，最遠可調整至 30 天內的照片。
- **地點限制**: 僅顯示包含 GPS 定位資訊 (`location != nil`) 的照片。
- **定位修改偵測**: 若 `PHAsset.location` 與 EXIF GPS 距離 > 100m，判定為修改，阻擋選取。

---

### 5.4 編輯頁面圖片管理 (Edit Page Image Management)

> **UI 型式**：橫向滾動的圖片長條 (Horizontal Scroll View)。

#### A. 刪除邏輯 (Delete)

- **UI**: 每張圖右上角顯示「X」按鈕。
- **行為**: 點擊刪除後，該圖移除，**後方圖片自動往前遞補**。
- **範例**: 刪除 `5` 號圖，原 `6` 號圖自動變為 `5` 號。

#### B. 更換邏輯 (Replace)

- **情境**: 使用者想換掉某一張拍不好的照片，但不改變順序。
- **操作**: 點擊該圖片本身。
- **行為**:
  1. 開啟相簿選擇器，進入**「單選模式」**。
  2. 使用者選定一張新圖。
  3. 新圖直接**填入原位置** (Index 不變)。
  4. 觸發新圖的上傳流程 (API A-1)。

#### C. 排序邏輯 (Reorder)

- **操作**: 長按圖片 (Long Press) 進入拖拽模式 (Drag & Drop)。
- **行為**:
  1. 拖曳至新位置放開。
  2. 陣列順序即時更新 (Re-index)。
  3. **範例**: 把第 10 張拖到第 1 張位置，原 1~9 號自動順延變成 2~10 號。

---

## VI. 🧹 後台任務

### 6.1 孤兒檔案清理 (Orphaned File Cleanup)

- **目的**：維護系統整潔，避免為上傳失敗或中途放棄的檔案付費
- **機制**：定時任務（建議每小時執行）掃描 Image Media Model
- **條件**：`status = 'PENDING' AND uploaded_at < NOW() - INTERVAL '1 hour'`

**清理流程**：

```sql
-- 1. 查詢待清理記錄
SELECT id, user_id, client_key, original_public_url, thumbnail_public_url
FROM image_media
WHERE status = 'PENDING'
  AND uploaded_at < NOW() - INTERVAL '1 hour';

-- 2. 記錄清理日誌（追蹤用）
INSERT INTO cleanup_logs (id, deleted_image_id, deleted_user_id, client_key, reason, deleted_at)
SELECT
  uuid_generate_v4(),
  id,
  user_id,
  client_key,
  'PENDING_TIMEOUT',
  NOW()
FROM image_media
WHERE status = 'PENDING'
  AND uploaded_at < NOW() - INTERVAL '1 hour';

-- 3. 刪除資料庫記錄
DELETE FROM image_media
WHERE status = 'PENDING'
  AND uploaded_at < NOW() - INTERVAL '1 hour';
```

**同時執行**：透過 R2 API 刪除對應的原圖和縮圖檔案

### 6.2 清理日誌表 (Cleanup Logs Model)

| 欄位                 | 類型      | 備註                             |
| :------------------- | :-------- | :------------------------------- |
| **id**               | UUID (PK) | 日誌記錄 ID                      |
| **deleted_image_id** | UUID      | 被刪除的圖片 ID                  |
| **deleted_user_id**  | UUID      | 圖片所屬用戶 ID                  |
| **client_key**       | Text      | 前端識別碼（除錯追蹤用）         |
| **reason**           | Text      | 清理原因（如 `PENDING_TIMEOUT`） |
| **deleted_at**       | Timestamp | 清理時間                         |

> **維護建議**：清理日誌保留 30 天，超過 30 天的日誌可定期清除

### 6.3 詢問標點過期處理

- **目的**：詢問標點 48 小時後不再於地圖顯示
- **機制**：透過查詢過濾實現，後端資料保留供歷史查詢
- **查詢範例**：`WHERE created_at >= NOW() - INTERVAL '48 hours'`

---

## VII. 🔐 權限控制摘要

| 操作          | 權限                   |
| :------------ | :--------------------- |
| 編輯/刪除標點 | 僅作者本人             |
| 編輯/刪除回覆 | 僅作者本人             |
| 點讚          | 任何登入使用者         |
| 查看詳情      | 任何使用者（含未登入） |
| 建立標點/回覆 | 僅登入使用者           |

---

## VIII. 📊 資料阻擋規則對照表

> 與 PRD 核心原則 2.2 完全一致

| 操作情境         | 圖片 GPS 要求 | 行為邏輯                                                                 |
| :--------------- | :------------ | :----------------------------------------------------------------------- |
| 建立「紀錄標點」 | **強制**      | 阻擋/過濾。Smart Filter 只顯示有 GPS 的照片。                            |
| 建立「詢問標點」 | 無限制        | 不阻擋。若無 GPS，欄位留空。                                             |
| 回覆「紀錄標點」 | 無限制        | 不阻擋。允許上傳截圖或無座標照片。                                       |
| 回覆「詢問標點」 | 無限制        | 不阻擋。有 GPS 且在範圍內 → `is_onsite=true`；否則 → `is_onsite=false`。 |

---

## IX. 📏 數量與限制彙總表

| 限制項目             | 數值                  | 適用情境             |
| :------------------- | :-------------------- | :------------------- |
| 紀錄模式圖片上限     | 1 ~ 10 張             | 建立紀錄標點         |
| 詢問模式附圖上限     | 0 ~ 5 張              | 建立詢問標點         |
| 回覆附圖上限         | 0 ~ 5 張              | 回覆標點             |
| 單張圖片最大大小     | 20 MB                 | 所有上傳             |
| 允許的圖片格式       | JPEG, PNG, HEIC, WebP | 所有上傳             |
| Presigned URL 有效期 | 15 分鐘               | 兩階段上傳流程       |
| 詢問標點生命週期     | 48 小時               | 地圖顯示過濾         |
| 詢問範圍半徑選項     | 100m / 500m / 1km     | 建立詢問標點         |
| 相簿時間篩選預設     | 最近 7 天             | iOS 自定義相簿選擇器 |
| 相簿時間篩選最遠     | 30 天                 | iOS 自定義相簿選擇器 |
| 定位修改偵測門檻     | 100 公尺              | iOS 自定義相簿選擇器 |
| Geo-fencing 容許誤差 | +30 公尺              | 詢問模式回覆判定     |
| PENDING 清理超時     | 1 小時                | 後台孤兒檔案清理     |
| 清理日誌保留期限     | 30 天                 | 後台日誌維護         |

---

## X. 🗄️ 資料庫設定摘要

### PostGIS 擴展啟用

```sql
-- 在 Supabase SQL Editor 執行
CREATE EXTENSION IF NOT EXISTS postgis;
```

### 空間索引建立

```sql
-- Image Media 表的空間索引（加速地圖範圍查詢）
CREATE INDEX idx_images_location ON image_media USING GIST (location);

-- Ask 表的空間索引（加速詢問標點查詢）
CREATE INDEX idx_asks_center ON asks USING GIST (center);
```

### 座標類型說明

| 欄位                   | 類型                    | 說明             |
| :--------------------- | :---------------------- | :--------------- |
| `image_media.location` | `GEOMETRY(Point, 4326)` | 圖片拍攝座標     |
| `asks.center`          | `GEOMETRY(Point, 4326)` | 詢問標點中心座標 |

> **4326** 是 WGS84 座標參考系統（SRID），與 GPS 座標系統一致
