# 🗺️ iOS 地圖多圖標點與上傳系統規格文件 (最終版)

## 🎯 核心目標與設計原則

本系統旨在實現高效能、高擴展性、安全且資料完整的地圖標點功能。

| 目標 (Goal)      | 實踐機制 (Mechanism)                           | 關鍵優勢 (Key Benefit)                                                          |
| :--------------- | :--------------------------------------------- | :------------------------------------------------------------------------------ |
| **高併發與速度** | 前端直傳 Cloudflare R2（兩階段上傳）。         | 避免後端成為傳輸瓶頸，實現最快的上傳速度。                                      |
| **多圖精準對應** | **API 1 回傳 Key-Value 映射表 (client_key)**。 | **消除前端查找循環和混淆**，準確綁定圖片 Metadata。                             |
| **資料原子性**   | PENDING 狀態管理 與 後台清理任務。             | 確保檔案在 R2 儲存和 Supabase 記錄之間的一致性。                                |
| **資料完整性**   | **雙層座標儲存**。                             | 精準記錄標點位置 (`poi_coordinates`) 和圖片原始拍攝位置 (`image_coordinates`)。 |

---

## 💾 核心資料模型 (Supabase Tables)

系統使用兩個模型實現一對多關聯，並包含必要的時間戳欄位。

### 1. 📍 POI 標點主記錄 (Point of Interest Model)

儲存標點本身的核心資訊。

| 欄位名稱               | 職責                                            | 關鍵資料類型    |
| :--------------------- | :---------------------------------------------- | :-------------- |
| `id`                   | POI 的唯一 ID。                                 | Primary Key     |
| **`poi_coordinates`**  | **標點的中心位置** (使用者在地圖上選取的座標)。 | GeoJSON / Point |
| `title`, `description` | 標點的文字內容。                                | Text            |
| `user_id`              | 建立者。                                        | UUID            |
| **`created_at`**       | 記錄創建時間。                                  | Timestamp       |

### 2. 🖼️ 圖片媒體記錄 (Image Media Model)

儲存每一張圖片的 Metadata，並通過外鍵 `poi_id` 連結到 POI。

| 欄位名稱                   | 職責                                  | 關鍵資料類型    |
| :------------------------- | :------------------------------------ | :-------------- |
| `id`                       | 圖片記錄 ID。                         | Primary Key     |
| **`poi_id`**               | **連結到 POI 主記錄的外鍵。**         | Foreign Key     |
| **`status`**               | **原子性控制（PENDING/COMPLETED）。** | Enum            |
| **`original_public_url`**  | 永久的原圖 CDN URL。                  | Text            |
| **`thumbnail_public_url`** | 永久的縮圖 CDN URL。                  | Text            |
| **`image_coordinates`**    | **圖片 EXIF 中提取的拍攝座標。**      | GeoJSON / Point |
| **`captured_at`**          | 圖片 EXIF 提取的原始拍攝時間。        | Timestamp       |
| `uploaded_at`              | 圖片 Metadata 首次存入資料庫的時間。  | Timestamp       |

---

## 🚀 完整的多圖標點與上傳流程 (2 個 API 呼叫)

### 階段一：批次授權與預存 (API 1)

目標：為所有圖片建立 PENDING 記錄，並提供直傳憑證。

| 步驟                        | 說明                                                                                                       | 關鍵數據流                                                           |
| :-------------------------- | :--------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------- |
| **1. 前端數據準備**         | App 讀取所有圖片 EXIF，並為每張圖片生成一個 **`client_key`** (本地 UUID)。                                 | `client_key`, `fileType`, `fileSize`。                               |
| **2. API 1 呼叫**           | App 呼叫 `/api/v1/upload/request`，將所有 `image_requests` 打包成陣列傳送。                                |                                                                      |
| **3. 後端批次處理**         | 後端遍歷請求，為每張圖片：**創建 `PENDING` 記錄**、**生成 UUID**、**生成 4 個 URL**（兩組上傳/兩組公開）。 |                                                                      |
| **4. 後端回傳 (Key-Value)** | 後端將所有憑證打包成一個 **Key-Value 映射表**，鍵為 `client_key`。                                         | **回傳：** `upload_credentials` (Map)，包含 `upload_id` 和所有 URL。 |
| **5. 前端對應**             | App 使用本地的 `client_key` 立即從映射表中 **$O(1)$ 直接存取** 到對應的憑證，完成 Metadata 綁定。          |                                                                      |

### 階段二：檔案直傳與 Metadata 提交 (API 2)

目標：檔案傳輸到 R2，並原子性地更新 Supabase 狀態。

| 步驟                  | 說明                                                                                                                                                         | 關鍵數據流                                                                                                                                          |
| :-------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------- |
| **6. R2 傳輸**        | App 使用 Key-Value 映射表中獲得的 `original_upload_url` 和 `thumbnail_upload_url`，對每張圖片進行併發直傳。                                                  |                                                                                                                                                     |
| **7. API 2 呼叫**     | R2 傳輸成功後，App 呼叫 `/api/v1/upload/complete` 進行最終提交。                                                                                             | **提交：** `poiCoordinates`（整體座標）、`title`、以及包含所有圖片 Metadata（`upload_id`、`imageCoordinates`、`captured_at`）的 **`images` 陣列**。 |
| **8. 後端原子性更新** | 後端：1. 創建 **POI 主記錄**；2. 遍歷 `images` 陣列，根據 `upload_id` 找到 PENDING 記錄；3. 寫入所有 Metadata，並將狀態從 `PENDING` 變更為 **`COMPLETED`**。 |                                                                                                                                                     |

---

## 🖥️ 後端 API 規格明細

### 1. 🚀 API 1: 請求上傳授權 (多圖 Key-Value 模式)

| 規格              | 描述                                                                                                                         |
| :---------------- | :--------------------------------------------------------------------------------------------------------------------------- |
| **端點**          | `/api/v1/upload/request` (POST)                                                                                              |
| **請求 Payload**  | 包含 `image_requests` 陣列，陣列中每項必須帶有 **`client_key`**、`fileType` 和 `fileSize`。                                  |
| **回傳 Response** | 包含 `upload_credentials` **映射表 (Object/Map)**，鍵為前端傳入的 **`client_key`**，值為該圖片的憑證物件（含 `upload_id`）。 |

### 2. ✅ API 2: 提交完成 Metadata (多圖批次更新)

| 規格             | 描述                                                                                                                                                       |
| :--------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **端點**         | `/api/v1/upload/complete` (POST)                                                                                                                           |
| **請求 Payload** | 包含 `poiCoordinates` (POI 核心座標) 和 **`images` 陣列**。`images` 陣列中每項包含：**`upload_id`**、`imageCoordinates`、`captured_at`、和 `public_urls`。 |
| **後端操作**     | 創建 POI 主記錄，並對應 `images` 陣列中的 `upload_id` 批次更新所有圖片記錄的 Metadata 和狀態。                                                             |

### 3. 🗺️ API 4: 獲取單個標點詳情

| 規格         | 描述                                                                                            |
| :----------- | :---------------------------------------------------------------------------------------------- |
| **端點**     | `/api/v1/images/{poi_id}` (GET)                                                                 |
| **後端操作** | 對 **POI Model** 和 **Image Media Model** 執行 **JOIN 查詢**，並只返回 `COMPLETED` 的圖片記錄。 |

---

## 🧹 後台清理任務 (Orphaned File Cleanup Job)

後端必須有一個定時任務（Cron Job）：

- **頻率：** 每隔 N 分鐘 (e.g., 30 分鐘)。
- **動作：** 掃描 `Image Media Model`，找出所有 **`status` 為 PENDING** 且 `uploaded_at` 時間已超時的記錄。
- **清理：** 刪除這些記錄在 Cloudflare R2 上的檔案，然後刪除 Supabase 中的記錄，以維護數據整潔。
