# 📄 Product Requirements Document (PRD) - Raibu

**Version**: 3.0 (Final Consolidated)
**Date**: 2025/12
**Status**: Confirmed

---

## 1. 產品概述 (Product Overview)

本產品為一款基於地圖的即時影像分享應用，核心價值在於連結「真實的當下」與「社群的互助」。
系統區分為兩種核心模式：

1.  **紀錄模式 (Record Mode)**：鼓勵使用者記錄當下的生活軌跡，強調真實的影像資訊。
2.  **詢問模式 (Ask Mode)**：允許使用者針對特定地點提出疑問，尋求社群解答。

---

## 2. 核心原則：資料記錄與阻擋機制 (Core Principles)

此部分定義系統最底層的資料處理邏輯，確保資料品質同時兼顧使用者體驗。

### 2.1 全域資料記錄原則

- **盡可能讀取**：系統對於所有上傳的圖片（無論是標點或回覆），預設行為皆是盡可能讀取並儲存所有 Metadata (EXIF, GPS, 拍攝時間等)。
- **彈性處理**：
- 若圖片含有資訊 $\rightarrow$ 寫入資料庫對應欄位。
- 若圖片缺乏資訊 $\rightarrow$ 對應欄位留空 (Null) 或寫入 False，**不應因此產生錯誤**。

### 2.2 上傳阻擋規則 (The Blocking Rule)

整個 App 中，**只有一個情況**會因為圖片缺乏地理資訊而阻擋上傳：

| 操作情境                | 圖片 GPS 要求        | 行為邏輯                                                                                                                           |
| :---------------------- | :------------------- | :--------------------------------------------------------------------------------------------------------------------------------- |
| **1. 建立「紀錄標點」** | **強制 (Mandatory)** | **阻擋/過濾**。<br>相簿選單預設僅顯示有 GPS 的照片 (Smart Filter)，確保每一張紀錄標點的照片都能精確定位在地圖上。                  |
| **2. 建立「詢問標點」** | 無限制 (Optional)    | **不阻擋**。<br>若無 GPS，欄位留空，僅作為問題的輔助圖片。                                                                         |
| **3. 回覆「紀錄標點」** | 無限制 (Optional)    | **不阻擋**。<br>允許上傳截圖或無座標照片，視為一般討論。                                                                           |
| **4. 回覆「詢問標點」** | 無限制 (Optional)    | **不阻擋**。<br>若有 GPS 且在範圍內 $\rightarrow$ 後端標記為「實地」。<br>若無 GPS 或不在範圍內 $\rightarrow$ 後端標記為「一般」。 |

---

## 3. 功能模組詳細規格 (Feature Specifications)

### 3.1 紀錄模式 (Record Mode)

- **核心定義**：地圖的預設模式。紀錄標點本身不具備單一座標，其空間存在完全依賴於圖片。
- **觸發入口**：僅能透過介面上的「標點按鈕」進入（不可透過地圖長按）。

#### A. 新增流程 (Creation Flow)

1.  **圖片選擇 (必填)**：

- **數量**：1 ~ 10 張。
- **相簿預篩選 (Smart Filter)**：開啟相簿時，系統**僅顯示**帶有 GPS 資訊的照片，自動過濾掉無效圖片。
- **時間預設**：預設顯示一週內照片（使用者可調整篩選區間 最遠到一個月內）。

2.  **文字內容**：標點描述（必填）。

#### B. 地圖顯示 (Map Display)

- **視覺表現**：
- **不顯示**抽象的標點符號 (Pin)。
- **顯示**具體的**「圖片縮圖」**。
- **樣式細節**：縮圖外層需加上**白色圓形/方形邊框**，使其在地圖底圖上更明顯，並像一個可點擊的 Icon。
- **多圖邏輯**：若一則紀錄包含 3 張不同地點的圖片，地圖上將會在 3 個不同位置顯示該圖片（或被群集），點擊任一圖片皆開啟同一則紀錄視窗。

#### C. 詳細視窗 (Detail View)

- **UI 型式：3/4 高度 Bottom Sheet（底部滑出面板）。**：
- **手勢操作**：支援從頂部控制條 (Handle) 向下拖動以關閉視窗。
- **圖片顯示邏輯：**：
- **錨點定位 (Anchor)**：若該紀錄包含多張圖片（如：淡水、台北車站），使用者在地圖上點擊「淡水」的縮圖時，詳細視窗開啟後，圖片輪播 (Carousel) 需直接定位顯示該張淡水照片，而非從第一張開始。
- **顯示內容**：點描述、完整圖片輪播、建立時間、作者資訊。
- **互動功能**：
- **愛心**：對標點本身點讚。
- **回覆列表**：顯示所有回覆（無特殊分類標籤）。
- **更多選項**：位於視窗右上角，點擊喚起管理功能選單。

#### D. 管理功能（Management）

- **權限限制**
- 僅標點作者本人可見

- **編輯（Edit）**
- 點擊後進入與「新增流程」相同的介面（帶入既有資料）
- 允許使用者：
  - 新增／刪除照片
  - 修改描述文字
- 儲存後：

  - 更新資料庫
  - 刷新地圖顯示

- **刪除（Delete）**
- **觸發**：
  - 點擊刪除後，跳出再次確認視窗（Popup Alert）
  - 提示文字：
    > 確定要刪除此標點嗎？此動作無法復原。
- **執行**：
  - 使用者確認後
  - 刪除整則紀錄
  - 包含該紀錄下所有照片，其座標點皆自地圖移除

---

### 3.2 詢問模式 (Ask Mode)

- **核心定義**：針對特定地點提出疑問。標點具有生命週期限制。
- **觸發入口**：

1.  **地圖長按 (Long Press)**：直接以該座標為提問中心，喚起新增視窗。
2.  **模式切換**：切換至詢問模式後點擊按鈕，需手動搜尋或指定地圖位置。

#### A. 新增流程 (Creation Flow)

1.  **位置設定**：鎖定長按點或搜尋結果。
2.  **詢問範圍設定 (Query Radius)**：

- **UI 元件**：範圍滑桿 (Range Slider) 搭配地圖圓圈預覽。
- **預設值**：半徑 500 公尺。
- **操作**：使用者拖動滑桿調整圓形範圍大小。
- **刻度/選項**：滑桿上設有固定刻度點（例如：**100m, 500m, 1km**），方便快速吸附，亦可微調。

3.  **內容輸入**：

- **問題內容**：文字描述（必填）。
- **附圖**：0 ~ 5 張（無 Metadata 限制，無時間限制，僅作輔助說明）。

#### B. 地圖顯示 (Map Display)

- **視覺表現**：顯示「問號圖示 (Icon)」。
- **顯示規則**：
- **時效限制 (Hard Limit)**：僅顯示過去 **48 小時內**新增的提問。時間一到即不再顯示（無論狀態為何）。
- **狀態標記**：雖然前端僅顯示 48 小時內，但後端需記錄「進行中」與「已解決」狀態供未來查詢或列表使用。

#### C. 詳細視窗 (Detail View)

- **顯示內容**：問題文字、附圖、建立時間、作者。
- **隱藏資訊**：UI 不特別顯示「狀態」或「倒數計時」（除非快到期才提示，保持簡潔）。
- **互動功能**：愛心、回覆列表。
- **更多選項**：位於視窗右上角，點擊喚起管理功能選單。

#### D. 管理功能（Management）

- **同紀錄模式的管理功能**

---

### 3.3 回覆與互動系統 (Reply & Interaction)

#### A. 回覆邏輯 (Reply Logic)

- **通用規則**：所有回覆皆以列表呈現，依時間排序。
- **回覆內容**：
  - **文字內容**：必填。
  - **附圖**：0 ~ 5 張（無 Metadata 限制，僅作輔助說明）。
- **詢問模式回覆的後端處理 (Backend Only)**：
  - 系統執行「地理圍欄 (Geo-fencing)」運算。
  - **判斷式**：`(圖片有 GPS) AND (座標在詢問範圍+30公尺內)`
  - **Yes** $\rightarrow$ 寫入資料庫 `is_onsite = true` (實地回報)。
  - **No** $\rightarrow$ 寫入資料庫 `is_onsite = false` (一般討論)。
- **前端呈現**：UI **不顯示**「實地/一般」標籤，保持介面乾淨，此欄位僅供後端排序權重或數據分析使用。

#### B. 社交互動

- **愛心 (Like)**：
- 針對「標點本身」可點愛心。
- 針對「每一則回覆」亦可獨立點愛心。

---

## 4. 地圖顯示與群集演算法 (Map Display & Clustering)

### 4.1 全域地圖功能

- **預設模式**：進入 App 時預設為 **紀錄模式**。
- **模式切換**：介面上提供按鈕快速切換「紀錄模式（顯示照片）」與「詢問模式（顯示問號）」。
- **搜尋**：支援一般地點搜尋 (POI)。
- **定位**：縮放至使用者當前位置。

### 4.2 群集演算法 (Clustering Algorithm)

採用「基於像素距離的動態群集」機制，優化效能與視覺體驗。

- **核心參數**：

- **R (螢幕像素半徑)**：聚合判定的恆定門檻 (e.g., 40px)。
- **Z (縮放等級)**：當前地圖 Zoom Level。
- **D (地理距離)**：由 R 與 Z 動態換算的實際距離。

- **運作邏輯**：

- 當兩點在螢幕上的距離 < R，系統將其合併為一個群集圖標（顯示數量）。
- **Zoom Out**：D 變大 → 高聚合。
- **Zoom In**：D 變小 → 低聚合。

- **遞進式點擊行為（Progressive Interaction）**

- **行為一：自動放大**

  - 條件：群集尚未達最大縮放極限
  - 操作：
    - 點擊群集
    - 地圖中心移至群集中心
    - 自動進行 Zoom In

- **行為二：列表視窗**
  - 條件：
    - 地圖已達最大縮放極限（Max Zoom）
    - 標點仍發生重疊（如同一地點、同一時間拍攝，螢幕距離仍 < R
  - **UI 型式**
    - 彈出 3/4 高度 Bottom Sheet
    - 顯示重疊標點的縮圖與摘要列表
  - **手勢操作**
    - 支援向下滑動關閉
  - **點擊行為**
    - 點擊列表任一項目
    - 保持 Bottom Sheet 型式
    - 內容切換為該筆紀錄的詳細視窗（Detail View）

---

## 5. 個人資訊頁面 (Profile Page)

- **基本資料**：使用者頭像、名稱。
- **數據統計**：標點總數、總被觀看次數。
- **列表管理**：使用者的標點列表。
- **系統功能**：登出。
